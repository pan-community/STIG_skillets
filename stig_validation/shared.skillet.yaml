---

name: shared_snippets
label : Shared snippets for gathering information

description: These snippets are shared between STIGs

type: pan_validation
labels:
    collection:
        - stig
        - Validation

variables:

snippets:

    - name: get_system_info
      cmd: cli
      cmd_str: show system info
      output_type: xml
      outputs:
        - name: operational_mode
          capture_value: /system/operational-mode/text()

    - name: capture_av_profile_in_policies
      cmd: parse
      variable: config
      outputs:
        - name: valid_av_profiles
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profiles/virus/entry
            [
              (decoder/entry[@name='smtp']/action='drop' or decoder/entry[@name='smtp']/action='reset-both')
              and (decoder/entry[@name='smtp']/wildfire-action='drop' or decoder/entry[@name='smtp']/wildfire-action='reset-both')
              and (decoder/entry[@name='pop3']/action='drop' or decoder/entry[@name='pop3']/action='reset-both')
              and (decoder/entry[@name='pop3']/wildfire-action='drop' or decoder/entry[@name='pop3']/wildfire-action='reset-both')
              and (decoder/entry[@name='imap']/action='drop' or decoder/entry[@name='imap']/action='reset-both')
              and (decoder/entry[@name='imap']/wildfire-action='drop' or decoder/entry[@name='imap']/wildfire-action='reset-both')
            ]/@name
        - name: invalid_av_profiles
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profiles/virus/entry/@name
          filter_items: item not in valid_av_profiles
        - name: valid_av_profile_groups
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profile-group/
            entry[count(virus) > 0 and not(virus/member='default')]/@name
        - name: invalid_av_profile_groups
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profile-group/entry/@name
          filter_items: item not in valid_av_profile_groups
        # At this point we can assume all profiles and profile-groups have vaild antivirus settings
        - name: invalid_security_policies_av
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/rulebase/security/rules/entry
            [
              action='allow'
              and (
                count(profile-setting/group/member) = 0
                and (
                  count(profile-setting/profiles/virus/member) = 0
                  or profile-setting/profiles/virus/member='default'
                )
              ) 
            ]/@name

    - name: capture_virus_alerting
      cmd: parse
      variable: config
      outputs:
        - name: device_server_profile_email
          capture_list: /config/shared/log-settings/email/entry/@name
        - name: log_profiles_with_email 
          capture_list: | 
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/log-settings/profiles/entry
            [count(match-list/entry/send-email/member) > 0]/@name
        - name: security_policies_with_virus_no_email
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/rulebase/security/rules/entry
            [
              action='allow'
              and not(disabled="yes")
              and (
                count(profile-seting/profile/virus/member) > 0
                or count(profile-setting/group/member) > 0
              )
            ]
          filter_items: item | element_value('log-setting') not in log_profiles_with_email 
        - name: security_policies_with_virus_no_email_names
          capture_expression: security_policies_with_virus_no_email | map(attribute="entry.@name") | list 

    - name: capture_icmp_deny_policy
      cmd: parse
      variable: config
      outputs:
        - name: icmp_deny_policy
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="deny" and not(disabled="yes") and source/member="any" and destination/member="any"
            and application/member="icmp" and application/member="ipv6-icmp" and application/member="traceroute"]
          filter_items: |
             untrusted_zones | listify | items_present(item.entry.from.member) or "any" in item.entry.from.member
             and trusted_zones | listify | items_present(item.entry.to.member) or "any" in item.entry.to.member
