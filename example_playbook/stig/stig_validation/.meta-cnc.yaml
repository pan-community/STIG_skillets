---

name: ALG_Validation
label: skillet generated from ALG STIG documents at stigviewer.com

description: This skillet accounts ALG STIG versions

type: pan_validation
labels:
    collection:
        - stig
        - Validation

variables:

  - name: traffic_intermediary
    description: NGFW is used for intermediary services
    type_hint: dropdown
    default: true
    dd_list:
      - key: Yes
        value: true
      - key: No
        value: false

  - name: TLS_gw
    description: NGFW is used as TLS Gateway
    type_hint: dropdown
    default: true
    dd_list:
      - key: Yes
        value: true
      - key: No
        value: false

  - name: VPN_concentrator
    description: NGFW is used as VPN Concentrator
    type_hint: dropdown
    default: true
    dd_list:
      - key: Yes
        value: true
      - key: No
        value: false

  - name: use_WMI
    description: WMI Probing is in use
    type_hint: dropdown
    default: false
    dd_list:
      - key: Yes
        value: true
      - key: No
        value: false

  - name: PPSM_endpoints
    description: Endpoints permitted by PPSM in CIDR format
    type_hint: list
    default: 192.168.1.0/24

  - name: PPSM_applications
    description: Endpoints permitted by PPSM in CIDR format
    type_hint: list
    default: web-browsing

  - name: PPSM_services
    description: Endpoints permitted by PPSM in CIDR format
    type_hint: list
    default: service-https

  - name: trusted_zones
    description: Security zones conntaining trusted hosts (Includes DMZ)
    type_hint: list
    default: trust

  - name: untrusted_zones
    description: Security zones conntaining untrusted hosts
    type_hint: list
    default: untrust

  - name: netflow_interfaces
    description: Interfaces collecting netflow information
    type_hint: list
    default: ethernet1/1

  - name: unauthorized_applications
    description: Applications that should be explicitly denied and logged
    type_hint: list
    default: web-browsing

  - name: apps_with_vulnerability_protection
    description: Applications that should have vulnerability protection applied
    type_hint: list
    default: web-browsing

  - name: alert_mechanism
    description: How the ISSO and ISSM receive alerts
    type_hint: dropdown
    default: snmptrap
    dd_list:
      - key: snmptrap
        value: send-snmptrap
      - key: syslog
        value: send-syslog
      - key: email
        value: send-email

  - name: dos_strategy
    description: DoS Prevention Strategy
    type_hint: dropdown
    default: zone
    dd_list:
      - key: Zone
        value: zone
      - key: Dos
        value: dos

snippets:

    - name: PANW-AG-000015-capture
      cmd: parse
      variable: config
      outputs:
        - name: decryption_rules
          capture_list: |-
            /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/rulebase/decryption/rules/entry
            [not(action="no-decrypt") and not(disabled="yes")]

        - name: security_policies
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry

        - name: decryption
          capture_expression: |
            decryption_rules |
            json_query('[*].entry[].{source_zone: [from.member][], source_ip: [source.member][],
            source_user: ["source-user".member][], destination_zone: [to.member][],
            destination_ip: [destination.member][], service: [service.member][]}'
            )

        - name: decryption_names
          capture_expression: |-
            decryption_rules |
            json_query('[*].entry[].{name: "@name", source_zone: [from.member][], source_ip: [source.member][],
            source_user: ["source-user".member][], destination_zone: [to.member][],
            destination_ip: [destination.member][], service: [service.member][]}'
            )

        - name: security
          capture_expression: |-
            security_policies |
            json_query('[*].entry[].{name: "@name", source_zone: [from.member][], source_ip: [source.member][],
            source_user: ["source-user".member][], destination_zone: [to.member][],
            destination_ip: [destination.member][], service: [service.member][]}'
            )
      tags:
        - PANW-AG-000015

    - name: PANW-AG-000015
      label: |-
        The Palo Alto Networks security platform, if used to provide intermediary services for remote access
        communications traffic (TLS or SSL decryption), must ensure inbound and outbound traffic is monitored for
        compliance with remote access security policies.
      meta:
        stig: alg
        severity: medium
      test: |
        (
        ( decryption | length > 0 )
        and ( decryption | difference(security)
        )

      when: traffic_intermediary
      fail_message: Click link for remediation instruction.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228832
      tags:
        - PANW-AG-000015

    - name: get_system_info
      cmd: cli
      cmd_str: show system info
      output_type: xml
      outputs:
        - name: operational_mode
          capture_value: /system/operational-mode/text()
      tags:
        - PANW-AG-000016
        - PANW-AG-000017
        - PANW-AG-000020
        - PANW-AG-000141
        - PANW-AG-000143
        - online_mode_only

    - name: PANW-AG-000016
      label: |
        The Palo Alto Networks security platform, if used as a TLS gateway/decryption point or VPN concentrator,
        must use encryption services that implement NIST FIPS-validated cryptography to protect the confidentiality of
        remote access sessions.
      meta:
        stig: alg
        severity: medium
      test: operational_mode == 'fips-cc'
      when: traffic_intermediary | default('no')
      fail_message: The NGFW must be running in FIPS mode
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228833
      tags:
        - PANW-AG-000016
        - online_mode_only

    - name: PANW-AG-000017
      label: |
        The Palo Alto Networks security platform that stores secret or private keys must use FIPS-approved key
        management technology and processes in the production and control of private/secret cryptographic keys.
      meta:
        stig: alg
        severity: medium
      test: operational_mode == 'fips-cc'
      fail_message: The NGFW must be running in FIPS mode
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228834
      tags:
        - PANW-AG-000017
        - online_mode_only

    - name: PANW-AG-000020
      label: |
        The Palo Alto Networks security platform, if used as a TLS gateway/decryption point or VPN concentrator,
        must use NIST FIPS-validated cryptography to protect the integrity of remote access sessions.
      meta:
        stig: alg
        severity: medium
      when: TLS_gw or VPN_concentrator
      test: operational_mode == 'fips-cc'
      fail_message: The NGFW must be running in FIPS mode
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228835
      tags:
        - PANW-AG-000020
        - online_mode_only

    - name: deny_no_log_policies
      cmd: parse
      variable: config
      outputs:
        - name: deny_no_log_pols
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="deny" and log-end="no" and not(log-start="yes") and not(disabled="yes")]
        - name: deny_no_log_policies_names
          capture_expression: deny_no_log_pols | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000024
        - PANW-AG-000113

    - name: PANW-AG-000024
      label: The Palo Alto Networks security platform must log violations of security policies.
      meta:
        stig: alg
        severity: low
      test: not deny_no_log_policies_names
      fail_message: Deny policies without logging - {% for pol in deny_no_log_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228836
      tags:
        - PANW-AG-000024

    - name: PANW-AG-000035
      label: The Palo Alto Networks security platform must only enable User-ID on trusted zones.
      meta:
        stig: alg
        severity: medium
      fail_message: Click link for remediation instruction.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228837
      include: CIS_NGFW_benchmark_v90
      include_snippets:
        - name: capture_userid_enabled_zones
        - name: userid_internal_zones_only
      tags:
        - PANW-AG-000035

    - name: PANW-AG-000036
      label: The Palo Alto Networks security platform must disable WMI probing if it is not used.
      meta:
        stig: alg
        severity: medium
      fail_message: Click link for remediation instruction.
      pass_message: Validation successful
      when: not use_WMI
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228838
      include: CIS_NGFW_benchmark_v90
      include_snippets:
        - name: captured_wmi_probing_disabled
        - name: wmi_probing_disabled
      tags:
        - PANW-AG-000036

    - name: capture_dns_proxy
      cmd: parse
      variable: config
      outputs:
        - name: capture_dns_proxy
          capture_list: /config/devices/entry[@name='localhost.localdomain']/network/dns-proxy/entry
        - name: capture_dns_proxy_names
          capture_expression: capture_dns_proxy | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000037

    - name: PANW-AG-000037
      label: The Palo Alto Networks security platform must not enable the DNS proxy.
      meta:
        stig: alg
        severity: medium
      test: not capture_dns_proxy_names
      fail_message: DNS proxy must not be configured
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228839
      tags:
        - PANW-AG-000037

    - name: capture_security_policy_objects
      cmd: parse
      variable: config
      outputs:
        - name: address_entries
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/address/entry
          filter_items: item | permitted_address(PPSM_endpoints | listify)
        - name: permitted_address_names
          capture_expression: address_entries | json_query('[].entry."@name"')
        - name: address_group_entries
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/address-group/entry
          filter_items: item | json_query('entry.static.member | [@][]') | items_present(permitted_address_names)
        - name: permitted_address_group_names
          capture_expression: address_group_entries | json_query('[].entry."@name"')
        - name: application_groups
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/application-group/entry
          filter_items: item | json_query('entry.members.member | [@][]') | items_present(PPSM_applications | listify)
        - name: permitted_application_groups_names
          capture_expression: application_groups | json_query('[].entry."@name"')
        - name: service_groups
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/service-group/entry
          filter_items: item | json_query('entry.members.member | [@][]') | items_present(PPSM_services | listify)
        - name: permitted_service_groups_names
          capture_expression: service_groups | json_query('[].entry."@name"')
        - name: non_approved_ppsm_policies
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry[action="allow" and not (disabled="yes")]
          filter_items: |
            (
              'any' in item.entry.source.member
              or 'any' in item.entry.destination.member
              or 'any' in item.entry.service.member
              or ('application-default' in item.entry.service.member and 'any' in item.entry.application.member)
              or not item | json_query('entry.source.[member][]') | items_present(permitted_address_names + permitted_address_group_names)
              or not item | json_query('entry.destination.[member][]') | items_present(permitted_address_names + permitted_address_group_names)
              or (
                not item | json_query('entry.application.[member][]') | items_present(PPSM_applications | listify + permitted_application_groups_names)
                and not 'any' in item.entry.application.member
                )
              or ( 'any' in item.entry.application.member
                and not item | json_query('entry.service.[member][]') | items_present(PPSM_services | listify + permitted_service_groups_names )
              )
            )
        - name: non_approved_ppsm_policies_names
          capture_expression: non_approved_ppsm_policies | json_query('[].entry."@name"')
      tags:
        - PANW-AG-000038
        - PANW-AG-000107

    - name: PANW-AG-000038
      label: The Palo Alto Networks security platform must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the PPSM CAL and vulnerability assessments.
      meta:
        stig: alg
        severity: medium
      test: not non_approved_ppsm_policies_names
      fail_message: Non PPSM approved policies - {%for pol in non_approved_ppsm_policies_names%}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228840
      tags:
        - PANW-AG-000038

    - name: get_decryption_policies
      cmd: parse
      variable: config
      outputs:
        - name: decryption_policies
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/decryption/rules/entry
        - name: ocsp_responders
          capture_list:  /config/shared/ocsp-responder/entry
      tags:
        - PANW-AG-000044
        - PANW-AG-000148

    - name: PANW-AG-000044
      label: The Palo Alto Networks security platform that provides intermediary services for TLS must validate certificates used for TLS functions by performing RFC 5280-compliant certification path validation.
      meta:
        stig: alg
        severity: medium
      when: TLS_gw
      test: not decryption_policies or ocsp_responders
      fail_message: OCSP responders must be configured if decryption is used
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228841
      tags:
        - PANW-AG-000044

    - name: PANW-AG-000047
      label: The Palo Alto Networks security platform must protect against the use of internal systems from launching Denial of Service (DoS) attacks against other networks or endpoints.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: Has to be tested and merged in.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228842

    - name: capture_spyware_profile
      cmd: parse
      variable: config
      outputs:
        - name: valid_spyware_profiles_names
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profiles/spyware/entry
            [not(botnet-domains/lists/entry/action/allow) and not(botnet-domains/lists/entry/action/alert)]/@name
        - name: valid_spyware_profile_groups
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/profile-group/entry[spyware/member]
          filter_items: item | json_query('entry.spyware.member') in valid_spyware_profiles_names
        - name:  valid_spyware_profile_groups_names
          capture_expression: valid_spyware_profile_groups | json_query('[].entry."@name"')
        - name: invalid_spyware_security_policies
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry[action="allow" and not (disabled="yes")]
          filter_items: |
              (item | json_query('entry.from.member | [@][]') | item_present(trusted_zones | listify) or 'any' in item.entry.from.member)
              and (item | json_query('entry.to.member | [@][]') | item_present(untrusted_zones | listify) or 'any' in item.entry.to.member)
              and (
                (not item | json_query('entry."profile-setting".group.member') and not item | json_query('entry."profile-setting".profiles.spyware.member'))
                or (
                  not item | json_query('entry."profile-setting".group.member')  | item_present(valid_spyware_profile_groups_names)
                  and not item | json_query('entry."profile-setting".profiles.spyware.member')  | item_present(valid_spyware_profiles_names)
                )
              )
        - name: invalid_spyware_security_policies_names
          capture_expression: invalid_spyware_security_policies | json_query('[].entry."@name"')
      tags:
        - PANW-AG-000049

    - name: PANW-AG-000049
      label: The Palo Alto Networks security platform must block phone home traffic.
      meta:
        stig: alg
        severity: medium
      test: not invalid_spyware_security_policies_names
      fail_message: Policies with invalid spyware profile - {% for pol in invalid_spyware_security_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228843
      tags:
        - PANW-AG-000049

    - name: capture_zone_protect_profile_crafted_pkts
      cmd: parse
      variable: config
      outputs:
        - name: zone_protect_profile_pkt_attack_enabled
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/network/profiles/zone-protection-profile/entry
            [discard-ip-spoof='yes']/@name
        - name: zones_with_pkt_attack_enabled_object
          capture_object: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/zone/entry
          filter_items: |-
            item | element_value('network.zone-protection-profile') not in zone_protect_profile_pkt_attack_enabled
        - name: zones_permitting_spoofing
          capture_expression: zones_with_pkt_attack_enabled_object | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000050

    - name: PANW-AG-000050
      label: The Palo Alto Networks security platform must deny outbound IP packets that contain an illegitimate address in the source address field.
      meta:
        stig: alg
        severity: medium
      test: not zones_permitting_spoofing
      fail_message: Zones that permit IP Spoofing - {% for zone in zones_permitting_spoofing %}{{ zone }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228844
      tags:
        - PANW-AG-000050

    - name: capture_default_permit_policy
      cmd: parse
      variable: config
      outputs:
        - name: default_any_any_policies
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [application/member="any" and source/member="any" and destination/member="any" and action="allow" and not (disabled="yes")]/@name
      tags:
        - PANW-AG-000051

    - name: PANW-AG-000051
      label: The Palo Alto Networks security platform must deny network communications traffic by default and allow network communications traffic by exception (i.e., deny all, permit by exception).
      meta:
        stig: alg
        severity: medium
      test: not default_any_any_policies
      fail_message: Policies that permit by default - {% for pol in default_any_any_policies %}{{ pol }}{% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228845
      tags:
        - PANW-AG-000051

    - name: capture_device_session_timeout_tcp
      cmd: parse
      variable: config
      outputs:
        - name: device_session_timeout_tcp
          capture_value: /config/devices/entry[@name='localhost.localdomain']/deviceconfig/setting/session/timeout-tcp
        - name: device_session_timeout_udp
          capture_value: /config/devices/entry[@name='localhost.localdomain']/deviceconfig/setting/session/timeout-udp
        - name: override_app_timeout
          capture_list: /config/shared/override/application/entry[tcp-timeout > 900 or udp-timeout > 900]/@name
        - name: custom_app_timeout
          capture_list: /config/devices/entry[@name='localhost.localdomain']/vsys/entry[@name='vsys1']/application/entry[tcp-timeout > 900 or udp-timeout > 900]/@name
      tags:
        - PANW-AG-000052

    - name: PANW-AG-000052
      label: The Palo Alto Networks security platform must terminate communications sessions after 15 minutes of inactivity.
      meta:
        stig: alg
        severity: medium
      # TCP default is higher than 900 so there must be a configuration element to be valid
      test: (
         device_session_timeout_tcp | int < 901
         and ( not device_session_timeout_udp or device_session_timeout_udp | int < 901 )
         and not override_app_timeout
         and not custom_app_timeout
         )
      fail_message: |
        {% if device_session_timeout_tcp | int > 900 or device_session_timeout_udp | int > 900 %}Default session timeout for TCP or UDP too high. {% endif %}
        {% if override_app_timeout or custom_app_timeout %}Applications with timeout above 900: {% for app in custom_app_timeout %}{{ app }} {% endfor %} {% for app in override_app_timeout %}{{ app }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228846
      tags:
        - PANW-AG-000052

    - name: capture_system_check
      cmd: cli
      cmd_str: request system software check
      output_type: xml
      outputs:
        - name: capture_system_check
          capture_list: /*
      tags:
        - PANW-AG-000060

    - name: PANW-AG-000060
      label: The Palo Alto Networks security platform must update malicious code protection mechanisms and signature definitions whenever new releases are available in accordance with organizational configuration management policy and procedures.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: As this may be a manual process it should be verified manually.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228847
      tags:
        - PANW-AG-000060

    - name: capture_av_profile_in_policies
      include: shared_snippets
      include_snippets:
        - name: capture_av_profile_in_policies
      tags:
        - PANW-AG-000062
        - PANW-AG-000063
        - PANW-AG-000073
        - PANW-AG-000074

    - name: PANW-AG-000062
      label: The Palo Alto Networks security platform must drop malicious code upon detection.
      meta:
        stig: alg
        severity: medium
      test: not( invalid_av_profiles or invalid_av_profile_groups or invalid_security_policies_av )
      fail_message: |
        {% if invalid_av_profiles %}Invalid AV profiles - {% for prof in invalid_av_profiles %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_av_profile_groups %}Invalid profile groups - {% for prof in invalid_av_profile_groups %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_security_policies_av %}Security policies with invalid AV - {% for pol in invalid_security_policies_av %}{{ pol }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228848
      tags:
        - PANW-AG-000062

    - name: PANW-AG-000063
      label: The Palo Alto Networks security platform must delete or quarantine malicious code in response to malicious code detection.
      meta:
        stig: alg
        severity: medium
      test: not( invalid_av_profiles or invalid_av_profile_groups or invalid_security_policies_av )
      fail_message: |
        {% if invalid_av_profiles %}Invalid AV profiles - {% for prof in invalid_av_profiles %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_av_profile_groups %}Invalid profile groups - {% for prof in invalid_av_profile_groups %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_security_policies_av %}Security policies with invalid AV - {% for pol in invalid_security_policies_av %}{{ pol }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228849

    - name: capture_virus_alerting
      include: shared_snippets
      include_snippets:
        - name: capture_virus_alerting
      tags:
        - PANW-AG-000064

    - name: PANW-AG-000064
      label: The Palo Alto Networks security platform must send an immediate (within seconds) alert to the system administrator, at a minimum, in response to malicious code detection.
      meta:
        stig: alg
        severity: medium
      test: not security_policies_with_virus_no_email_names
      fail_message: AV policies that do not have email logging - {% for pol in security_policies_with_virus_no_email_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228850
      tags:
        - PANW-AG-000064

    - name: PANW-AG-000065
      label: The Palo Alto Networks security platform must automatically update malicious code protection mechanisms.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: As this may be a manual process it should be verified manually.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228851

    - name: PANW-AG-000073
      label: The Palo Alto Networks security platform must deny or restrict detected prohibited mobile code.
      meta:
        stig: alg
        severity: medium
      test: not( invalid_av_profiles or invalid_av_profile_groups or invalid_security_policies_av )
      fail_message: |
        {% if invalid_av_profiles %}Invalid AV profiles - {% for prof in invalid_av_profiles %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_av_profile_groups %}Invalid profile groups - {% for prof in invalid_av_profile_groups %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_security_policies_av %}Security policies with invalid AV - {% for pol in invalid_security_policies_av %}{{ pol }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228852
      tags:
        - PANW-AG-000073

    - name: PANW-AG-000074
      label: The Palo Alto Networks security platform must prevent the download of prohibited mobile code.
      meta:
        stig: alg
        severity: medium
      test: not( invalid_av_profiles or invalid_av_profile_groups or invalid_security_policies_av )
      fail_message: |
        {% if invalid_av_profiles %}Invalid AV profiles - {% for prof in invalid_av_profiles %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_av_profile_groups %}Invalid profile groups - {% for prof in invalid_av_profile_groups %}{{ prof }} {% endfor %}{% endif %}
        {% if invalid_security_policies_av %}Security policies with invalid AV - {% for pol in invalid_security_policies_av %}{{ pol }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228853
      tags:
        - PANW-AG-000074

    - name: PANW-AG-000078
      label: The Palo Alto Networks security platform, if used as a TLS gateway/decryption point or VPN concentrator, must control remote access methods (inspect and filter traffic).
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: Has to be tested and merged
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228854
      tags:
        - PANW-AG-000078

    - name: PANW-AG-000079
      label: The Palo Alto Networks security, if used as a TLS gateway/decryption point or VPN concentrator, must provide the capability to immediately disconnect or disable remote access to the information system.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: Has to be tested and merged
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228855
      tags:
        - PANW-AG-000079

    - name: capture_predefined_db_applications
      include: shared_snippets
      include_snippets:
        - name: capture_predefined_db_applications
      tags:
        - PANW-AG-000080

    - name: capture_vulnerability_profiles
      include: shared_snippets
      include_snippets:
        - name: capture_vulnerability_profiles
      tags:
        - PANW-AG-000080
        - PANW-AG-000081
        - PANW-AG-000105
        - PANW-AG-000148
        - PANW-AG-000149

    - name: capture_invalid_db_vulnerability_policies
      include: shared_snippets
      include_snippets:
        - name: capture_invalid_db_vulnerability_policies
      tags:
        - PANW-AG-000080

    - name: PANW-AG-000080
      label: To protect against data mining, the Palo Alto Networks security platform must detect and prevent SQL and other code injection attacks launched against data storage objects, including, at a minimum, databases, database records, queries, and fields.
      meta:
        stig: alg
        severity: medium
      test: not invalid_db_vulnerability_policies_names
      fail_message: DB policies with invalid vulnerability profiles - {% for pol in invalid_db_vulnerability_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228856
      tags:
        - PANW-AG-000080

    - name: capture_vulnerability_protected_apps
      include: shared_snippets
      include_snippets:
        - name: capture_vulnerability_protected_apps
      tags:
        - PANW-AG-000081

    - name: PANW-AG-000081
      label: To protect against data mining, the Palo Alto Networks security platform must detect and prevent code injection attacks launched against application objects including, at a minimum, application URLs and application code.
      meta:
        stig: alg
        severity: medium
      test: not invalid_vulnerability_app_policies_names
      fail_message: App policies with invalid vulnerability profile - {% for pol in invalid_vulnerability_app_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228857
      tags:
        - PANW-AG-000081

    - name: capture_logging_settings
      include: shared_snippets
      include_snippets:
        - name: capture_logging_settings

      tags:
        - PANW-AG-000094
        - PANW-AG-000144

    - name: PANW-AG-000094
      label: The Palo Alto Networks security platform must off-load audit records onto a different system or media than the system being audited.
      meta:
        stig: alg
        severity: medium
      test: valid_syslog_profiles and valid_syslog_log_forwarding_profile and valid_system_syslog_settings
      fail_message: |
        {% if not valid_syslog_profiles %}No valid syslog profiles. {% endif %}
        {% if not valid_syslog_log_forwarding_profile %}No valid syslog log forwarding profiles. {% endif %}
        {% if not valid_system_syslog_settings %}No valid system syslog forwarders.{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228858
      tags:
        - PANW-AG-000094

    - name: PANW-AG-000101
      label: The Palo Alto Networks security platform being used for TLS/SSL decryption using PKI-based user authentication must only accept end entity certificates issued by DoD PKI or DoD-approved PKI Certificate Authorities (CAs) for the establishment of protected sessions.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: false
      fail_message: Approved certificates have to be manually verified.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228859

    - name: PANW-AG-000102-capture
      cmd: parse
      variable: config
      outputs:
      -   name: zones_with_protection_profiles
          capture_value: /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/zone/entry/network/zone-protection-profile/../../@name
      -   name: zone_protection_profiles
          capture_list: /config/devices/entry[@name="localhost.localdomain"]/network/profiles/zone-protection-profile/entry/@name
      -   name: zones_with_intended_dos_zone_protection_profile
          capture_list: /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/zone/entry/network/zone-protection-profile[text()
              = "{{ dos_zone_protection_profile }}"]/../../@name
      -   name: dos_protection_policies
          capture_list: /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/rulebase/dos/rules/entry/@name
      -   name: internal_zone_with_intended_dos_protection_policy
          capture_list: /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/rulebase/dos/rules/entry/to/zone/member[text()
              = "{{ internal_zone }}"]
      -   name: dmz_zone_with_intended_dos_protection_policy
          capture_list: /config/devices/entry[@name="localhost.localdomain"]/vsys/entry[@name="vsys1"]/rulebase/dos/rules/entry/to/zone/member[text()
              = "{{ dmz_zone }}"]
      tags:
      - PANW-AG-000102

    - cmd: validate
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2019-12-20/finding/V-62601
      fail_message: Hit the Zone Fail Message
      label: The Palo Alto Networks security platform must protect against Denial of
          Service (DoS) attacks by employing rate-based attack prevention behavior analysis
          (traffic thresholds).
      name: PANW-AG-000102-zone
      output_type: validation
      pass_message: Hit Zone Pass Message
      meta:
        stig: alg
        severity: medium
      tags:
      - PANW-AG-000102
      test: |-
          (
          zone_protection_profiles | length
          and internal_zone in zones_with_protection_profiles
          and dmz_zone in zones_with_protection_profiles
          and internal_zone in zones_with_intended_dos_zone_protection_profile
          and dmz_zone in zones_with_intended_dos_zone_protection_profile
          )
      when: dos_strategy == "zone"

    - cmd: validate
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2019-12-20/finding/V-62601
      fail_message: Hit DOS Fail Message
      label: The Palo Alto Networks security platform must protect against Denial of
          Service (DoS) attacks by employing rate-based attack prevention behavior analysis
          (traffic thresholds).
      name: PANW-AG-000102-dos
      output_type: validation
      pass_message: Hit DOS Pass Message
      meta:
        stig: alg
        severity: medium
      tags:
      - PANW-AG-000102
      test: |-
          (
          dos_protection_policies | length
          and internal_zone_with_intended_dos_protection_policy | length
          and dmz_zone_with_intended_dos_protection_policy | length
          )
      when: dos_strategy == "dos"

    - name: capture_vulnerability_profile_rules
      cmd: parse
      variable: config
      outputs:
        - name: invalid_vulnerability_interzone_security_policies
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [
              action="allow" and not(disabled="yes")
              and (
                not(to/member/text()=from/member/text())
                or to/member='any' or from/member='any'
                or count(to/member) > 1
                or count(from/member) > 1
                )
            ]
          filter_items: |-
            item | element_value('profile-setting.profiles.vulnerability.member') not in valid_vulnerability_profiles
            and item | element_value('profile-setting.group.member') not in valid_vulnerability_profile_groups
        - name: invalid_vulnerability_interzone_security_policies_names
          capture_expression: invalid_vulnerability_interzone_security_policies | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000105

    - name: PANW-AG-000105
      label: The Palo Alto Networks security platform must use a Vulnerability Protection Profile that blocks any critical, high, or medium threats.
      meta:
        stig: alg
        severity: medium
      test: not invalid_vulnerability_interzone_security_policies_names
      fail_message: Policies with bad vulnerability profiles - {% for pol in invalid_vulnerability_interzone_security_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228861
      tags:
        - PANW-AG-000105

    - name: PANW-AG-000107
      label: The Palo Alto Networks security platform must only allow incoming communications from organization-defined authorized sources forwarded to organization-defined authorized destinations.
      meta:
        stig: alg
        severity: medium
      test: not non_approved_ppsm_policies_names
      fail_message: Non approved policies - {%for pol in non_approved_ppsm_policies_names%}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228862
      tags:
        - PANW-AG-000107

    - name: capture_user_id_mapping
      cmd: cli
      cmd_str: show user ip-user-mapping all
      output_type: xml
      outputs:
        - name: captured_user_id_mapping
          capture_value: /*
      tags:
        - PANW-AG-000109
        - online_mode_only

    - name: PANW-AG-000109
      label: The Palo Alto Networks security platform must identify and log internal users associated with prohibited outgoing communications traffic.
      meta:
        stig: alg
        severity: medium
      test: captured_user_id_mapping
      fail_message: No user ID mapping ouitput found.
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228863
      tags:
        - PANW-AG-000109
        - online_mode_only

    - name: capture_netflow_profiles
      include: shared_snippets
      include_snippets:
        - name: capture_netflow_profiles
      tags:
        - PANW-AG-000111

    - name: PANW-AG-000111
      label: The Palo Alto Networks security platform must be configured to integrate with a system-wide intrusion detection system.
      meta:
        stig: alg
        severity: low
      test: not interfaces_missing_netflow
      fail_message: Interfaces missing netflow - {% for int in interfaces_missing_netflow %}{{ int }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228864
      tags:
        - PANW-AG-000111

    - name: capture_unauthorized_policies
      cmd: parse
      variable: config
      outputs:
        - name: unauthorized_policies
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="deny" and not(log-end="no") and not(disabled="yes") and not(application/member="any")]
        - name: denied_and_logged_applications
          capture_expression: unauthorized_policies | json_query('[].entry.application.member | [@][][]')
        - name: unauthorized_not_explicitly_denied_applications
          capture_expression: unauthorized_applications | listify | difference(denied_and_logged_applications)
      tags:
        - PANW-AG-000112

    - name: PANW-AG-000112
      label: The Palo Alto Networks security platform must detect use of network services that have not been authorized or approved by the ISSM and ISSO, at a minimum.
      meta:
        stig: alg
        severity: medium
      test: not unauthorized_not_explicitly_denied_applications
      fail_message: Unauthorized applications not explicitly denied and logged - {% for app in unauthorized_not_explicitly_denied_applications %}{{ app }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228865
      tags:
        - PANW-AG-000112

    - name: PANW-AG-000113
      label: The Palo Alto Networks security platform must generate a log record when unauthorized network services are detected.
      meta:
        stig: alg
        severity: medium
      test: not deny_no_log_policies_names
      fail_message: Deny policies without logging - {% for pol in deny_no_log_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228866
      tags:
        - PANW-AG-000113

    - name: deny_no_log_setting
      cmd: parse
      variable: config
      outputs:
        - name: deny_no_log_pols
          capture_list: |-
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="deny" and not(log-setting) and not(disabled="yes")]/@name
      tags:
        - PANW-AG-000114

    - name: PANW-AG-000114
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when unauthorized network services are detected.
      meta:
        stig: alg
        severity: medium
      test: not deny_no_log_pols
      fail_message: Deny policies without forwarding profiles - {%for pol in deny_no_log_pols %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228867
      tags:
        - PANW-AG-000114

    - name: PANW-AG-000115
      label: The Palo Alto Networks security platform must continuously monitor inbound communications traffic crossing internal security boundaries.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: true
      fail_message: Click link for remediation instruction.
      pass_message: Validation requires manual review of architecture documentation
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228868
      tags:
        - PANW-AG-000115

    - name: PANW-AG-000116
      label: The Palo Alto Networks security platform must continuously monitor outbound communications traffic crossing internal security boundaries.
      meta:
        stig: alg
        severity: medium
        action_required: true
      test: true
      fail_message: Click link for remediation instruction.
      pass_message: Validation requires manual review of architecture documentation
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228869
      tags:
        - PANW-AG-000116

    - name: PANW-AG-000118
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when threats identified by authoritative sources (e.g., IAVMs or CTOs) are detected.
      meta:
        stig: alg
        severity: medium
      test: true
      fail_message: Click link for remediation instruction.
      pass_message: Validation requires manual review of architecture documentation
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228870
      tags:
        - PANW-AG-000118

    - name: capture_alert_mechanisms
      include: shared_snippets
      include_snippets:
        - name: capture_alert_mechanisms
      tags:
        - PANW-AG-000119
        - PANW-AG-000120
        - PANW-AG-000121
        - PANW-AG-000122

    - name: PANW-AG-000119
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when rootkits or other malicious software which allows unauthorized privileged access is detected.
      meta:
        stig: alg
        severity: medium
      test: not invalid_alert_mechanisms_policies_names
      fail_message: Policies without valid alerting - {% for pol in invalid_alert_mechanisms_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228871
      tags:
        - PANW-AG-000119

    - name: PANW-AG-000120
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when rootkits or other malicious software which allows unauthorized non-privileged access is detected.
      meta:
        stig: alg
        severity: medium
      test: not invalid_alert_mechanisms_policies_names
      fail_message: Policies without valid alerting - {% for pol in invalid_alert_mechanisms_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228872
      tags:
        - PANW-AG-000120

    - name: capture_invalid_alert_dos_policies
      include: shared_snippets
      include_snippets:
        - name: capture_invalid_alert_dos_policies
      tags:
        - PANW-AG-000121

    - name: PANW-AG-000121
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when denial of service incidents are detected.
      meta:
        stig: alg
        severity: medium
      test: valid_alert_dos_policies and not invalid_alert_dos_policies
      fail_message: |
        {% if not valid_alert_dos_policies %}No valid Dos Protection policies setup for alerts {% endif %}
        {% if invalid_alert_dos_policies %}DoS Protection policies with invalid log forwarding - {% for pol in invalid_alert_dos_policies %}{{ pol.entry["@name"] }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228873
      tags:
        - PANW-AG-000121

    - name: capture_interzone_intersubnet_alerts
      include: shared_snippets
      include_snippets:
        - name: capture_interzone_intersubnet_alerts
      tags:
        - PANW-AG-000122

    - name: PANW-AG-000122
      label: The Palo Alto Networks security platform must generate an alert to, at a minimum, the ISSO and ISSM when new active propagation of malware infecting DoD systems or malicious code adversely affecting the operations and/or security of DoD systems is detected.
      meta:
        stig: alg
        severity: medium
      test: not invalid_intersubnet_alert_policies_names
      fail_message: Intersubnet policies with invalid alerting - {% for pol in invalid_intersubnet_alert_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228874
      tags:
        - PANW-AG-000122

    - name: capture_icmp_deny_policy
      include: shared_snippets
      include_snippets:
        - name: capture_icmp_deny_policy
      tags:
        - PANW-AG-000127

    - name: PANW-AG-000127
      label: The Palo Alto Networks security platform must block traceroutes and ICMP probes originating from untrusted networks (e.g., ISP and other non-DoD networks).
      meta:
        stig: alg
        severity: medium
      test: icmp_deny_policy
      fail_message: An explicit deny policy could not be found, click link for requirements.
      pass_message: Identified policy - {% for pol in icmp_deny_policy %}{{ pol.entry["@name"] }} {% endfor %}
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228875
      tags:
        - PANW-AG-000127

    - name: PANW-AG-000141
      label: The Palo Alto Networks security platform providing encryption intermediary services must implement NIST FIPS-validated cryptography to generate cryptographic hashes.
      meta:
        stig: alg
        severity: medium
      when: traffic_intermediary
      test: operational_mode == 'fips-cc'
      fail_message: The NGFW must be running in FIPS mode
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228876
      tags:
        - PANW-AG-000141
        - online_mode_only

    - name: PANW-AG-000143
      label: The Palo Alto Networks security platform, if used for TLS/SSL decryption, must use NIST FIPS-validated cryptography to implement encryption.
      meta:
        stig: alg
        severity: medium
      when: TLS_gw
      test: operational_mode == 'fips-cc'
      fail_message: The NGFW must be running in FIPS mode
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228877
      tags:
        - PANW-AG-000143
        - online_mode_only

    - name: PANW-AG-000144
      label: The Palo Alto Networks security platform must, at a minimum, off-load threat and traffic log records onto a centralized log server in real time.
      meta:
        stig: alg
        severity: low
      test: valid_syslog_profiles and valid_syslog_log_forwarding_profile and valid_system_syslog_settings
      fail_message: |
        {% if not valid_syslog_profiles %}No valid syslog profiles. {% endif %}
        {% if not valid_syslog_log_forwarding_profile %}No valid syslog log forwarding profiles. {% endif %}
        {% if not valid_system_syslog_settings %}No valid system syslog forwarders.{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228878
      tags:
        - PANW-AG-000144

    - name: capture_smtp_policies_no_av
      cmd: parse
      variable: config
      outputs:
        - name: smtp_policies_no_av
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [
              action="allow"
              and not(disabled="yes")
              and (
                application/member/text()='smtp'
                or application/member/text()='smtp-base'
                or application/member/text()='smtp-starttls'
              )
            ]
          filter_items: |
            item | element_value('profile-setting.profiles.virus.member') not in valid_av_profiles
            and item | element_value('profile-setting.group.member') not in valid_av_profile_groups
        - name: smtp_policies_no_av_names
          capture_expression: smtp_policies_no_av | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000147

    - name: PANW-AG-000147
      label: The Palo Alto Networks security platform must inspect inbound and outbound SMTP and Extended SMTP communications traffic (if authorized) for protocol compliance and protocol anomalies.
      meta:
        stig: alg
        severity: medium
      test: not smtp_policies_no_av
      fail_message: SMTP policies without av - {% for pol in smtp_policies_no_av %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228879
      tags:
        - PANW-AG-000147

    - name: capture_ftp_policies_no_av
      cmd: parse
      variable: config
      outputs:
        - name: invalid_ftp_policies
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="allow" and not(disabled="yes") and application/member/text()='ftp']
          filter_items: |
            (
              item | element_value('profile-setting.profiles.virus.member') not in valid_av_profiles
              or item | element_value('profile-setting.profiles.vulnerability.member') not in valid_vulnerability_profiles
            ) and (
              item | element_value('profile-setting.group.member') not in valid_av_profile_groups
              or item | element_value('profile-setting.group.member') not in valid_vulnerability_profile_groups
            )
        - name: invalid_ftp_policies_names
          capture_expression: invalid_ftp_policies | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000148

    - name: PANW-AG-000148
      label: The Palo Alto Networks security platform must inspect inbound and outbound FTP and FTPS communications traffic (if authorized) for protocol compliance and protocol anomalies.
      meta:
        stig: alg
        severity: medium
      test: not decryption_policies and not invalid_ftp_policies
      fail_message: |
        {% if not decryption_policies %}This validation requiers decryption to be configured. {% endif %}
        {% if invalid_ftp_policies_names %}Policies without proper profiles - {% for pol in invalid_ftp_policies_names %}{{ pol }} {% endfor %}{% endif %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228880
      tags:
        - PANW-AG-000148

    - name: capture_invalid_http_policies
      cmd: parse
      variable: config
      outputs:
        - name: invalid_http_policies
          capture_list: |
            /config/devices/entry[@name='localhost.localdomain']/vsys/entry/rulebase/security/rules/entry
            [action="allow" and not(disabled="yes") and application/member/text()='web-browsing']
          filter_items: |
            (
              item | element_value('profile-setting.profiles.virus.member') not in valid_av_profiles
              or item | element_value('profile-setting.profiles.vulnerability.member') not in valid_vulnerability_profiles
            ) and (
              item | element_value('profile-setting.group.member') not in valid_av_profile_groups
              or item | element_value('profile-setting.group.member') not in valid_vulnerability_profile_groups
            )
        - name: invalid_http_policies_names
          capture_expression: invalid_http_policies | map(attribute="entry.@name") | list
      tags:
        - PANW-AG-000149

    - name: PANW-AG-000149
      label: The Palo Alto Networks security platform must inspect inbound and outbound HTTP traffic (if authorized) for protocol compliance and protocol anomalies.
      meta:
        stig: alg
        severity: medium
      test: not invalid_http_policies_names
      fail_message: Policies without proper profiles - {% for pol in invalid_http_policies_names %}{{ pol }} {% endfor %}
      pass_message: Validation successful
      documentation_link: https://www.stigviewer.com/stig/palo_alto_networks_alg/2020-09-28/finding/V-228881
      tags:
        - PANW-AG-000149
